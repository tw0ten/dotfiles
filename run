#!/usr/bin/env sh
git submodule update --init --recursive || exit

sudo -v || sudo() { false; }
cd() { command cd "$@" && echo "cd $*" || exit; }

( cd config
	i() { set -- "$1" "$i/${2:-"$1"}"
		mkdir -p "$(dirname "$2")"
		ln -sfT "$PWD/$1" "$2" || return
		echo "	ln '$2' < '$1'"; }

	( cd xdg; i="$HOME/.config"
		for f in *; do i "$f"; done )

	( cd home; i="$HOME"
		i bash/profile .bash_profile
		i bash/rc .bashrc
		i ssh/config .ssh/config
		i ssh/rc .ssh/rc
		i xinitrc .xinitrc
		i inputrc .inputrc )

	sudo -v || exit

	i() { set -- "$1" "$i/$2"
		sudo mkdir -p "$(dirname "$2")"
		sudo cp "$1" "$2" || return
		echo "	cp '$1' > '$2'"; }

	( cd etc; i='/etc'
		i pacman pacman.conf
		i ssh ssh/sshd_config
		i grub default/grub )
echo )

sudo -v && ( sudo pacman -Syu
	AUR_HELPER='paru'
	i() { $AUR_HELPER -S "$@"; }
	command -v $AUR_HELPER || ( cd "$(mktemp -d)"; git clone "https://aur.archlinux.org/$AUR_HELPER" . && makepkg -si )
	i neovim tmux openssh \
		lf btop fastfetch ripgrep reflector ufw
	i jdk-openjdk rustup python deno nasm
	i xorg xorg-xinit xkb-switch pipewire libnotify nvidia-open nvidia-utils nvidia-settings \
		ttf-jetbrains-mono ttf-nerd-fonts-symbols-mono noto-fonts-emoji noto-fonts-cjk \
		obs-studio vlc qbittorrent libreoffice-still gimp firefox torbrowser-launcher bemoji dunst picom flameshot feh
echo )

sudo -v && ( cd bin/src
	for i in */; do (
		cd "$i"
		./build
	) done
echo )

sudo -v && ( cd etc; i() { sudo "$@"; }
	i localectl set-x11-keymap us
	i localectl set-keymap --no-convert us

	i systemctl enable reflector.timer

	i cp cat.png /boot/grub/bg.png
	i grub-mkconfig -o /boot/grub/grub.cfg

	i ufw reset
	i ufw default deny incoming
	i ufw default allow outgoing
	i ufw allow ssh
	i ufw enable
echo )

exec "$SHELL"
